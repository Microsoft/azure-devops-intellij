// Copyright (c) Microsoft. All rights reserved.
// Licensed under the MIT license. See License.txt in the project root.

plugins {
    id "base"
    id "de.undercouch.download"
}

ext {
    sdkVersion = "14.134.0"
    sdkArchiveLocation = file("$buildDir/TFS-SDK-${sdkVersion}.zip")
    sdkUnpackLocation = file("$buildDir/sdk")
    sdkJarName = "com.microsoft.tfs.sdk-${sdkVersion}.jar"
}

task downloadArchive(type: Download) {
    src "https://github.com/microsoft/team-explorer-everywhere/releases/download/$sdkVersion/TFS-SDK-${sdkVersion}.zip"
    dest sdkArchiveLocation
    overwrite false
}

task verifyArchive(type: Verify, dependsOn: downloadArchive) {
    src sdkArchiveLocation
    algorithm "SHA-256"
    checksum "A7CD155475C034CB9A858B9497C473394B08D77DE90AB0A0325CF97F9ABA2055"
}

task unpack(type: Copy, dependsOn: [downloadArchive, verifyArchive]) {
    from(zipTree(sdkArchiveLocation)) {
        include "TFS-SDK-$sdkVersion/redist/lib/*.jar"
        eachFile { fcd ->
            fcd.relativePath = new RelativePath(true, fcd.relativePath.segments.drop(3))
        }
        includeEmptyDirs = false
    }
    into sdkUnpackLocation
}

artifacts.add("default", file("$sdkUnpackLocation/$sdkJarName")) {
    builtBy unpack
}